rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // üîê AUTHENTICATION & VERIFICATION
    // ============================================================

    // Registration OTPs ‚Äî allow unauthenticated read/write for signup
    match /pending_verifications/{email} {
      allow read, create: if true; // Anyone can request and verify OTP
      allow update: if false; // Prevent modification
      allow delete: if request.auth != null; // Only authenticated users can cleanup
    }

    // Password reset OTPs ‚Äî allow unauthenticated access for recovery
    match /password_resets/{email} {
      allow read, create: if true; // Anyone can request and verify password reset
      allow update: if false; // Prevent modification
      allow delete: if request.auth != null; // Only authenticated users can cleanup
    }

    // ============================================================
    // üéüÔ∏è REGISTRATION CODES
    // ============================================================
    
    // Registration codes ‚Äî owners can create, anyone authenticated can read/use
    match /registration_codes/{codeId} {
      // Anyone authenticated can read codes (needed to validate during system claiming)
      allow read: if request.auth != null;
      
      // Only system owners can create codes for their systems
      allow create: if request.auth != null 
                    && request.auth.token.email_verified == true
                    && request.resource.data.createdBy == request.auth.uid;
      
      // Only code creator can update (mark as used)
      allow update: if request.auth != null 
                    && request.auth.token.email_verified == true
                    && (resource.data.createdBy == request.auth.uid 
                        || request.auth.uid == request.resource.data.usedBy); // Allow user who uses it
      
      // Only code creator can delete
      allow delete: if request.auth != null 
                    && request.auth.token.email_verified == true
                    && resource.data.createdBy == request.auth.uid;
    }

    // ============================================================
    // üë§ USER DATA
    // ============================================================

    // User access control ‚Äî only owner can read/write their data
    match /userAccess/{uid} {
      allow read, write: if request.auth != null 
                         && request.auth.uid == uid
                         && request.auth.token.email_verified == true;
    }

    // User notifications ‚Äî only owner can access
    match /user_notifications/{uid} {
      allow read, write: if request.auth != null 
                         && request.auth.uid == uid
                         && request.auth.token.email_verified == true;
    }

    // ============================================================
    // üè≠ SYSTEM MANAGEMENT
    // ============================================================

    // System metadata ‚Äî authenticated users can read, owners can write
    match /systems/{systemId} {
      // Anyone authenticated can read (needed for system claiming)
      allow read: if request.auth != null 
                  && request.auth.token.email_verified == true;
      
      // Anyone authenticated can create a system (claiming)
      allow create: if request.auth != null 
                    && request.auth.token.email_verified == true
                    && request.resource.data.ownerId == request.auth.uid; // Must set self as owner
      
      // Only owner can update (except ownership transfer)
      allow update: if request.auth != null 
                    && request.auth.token.email_verified == true
                    && resource.data.ownerId == request.auth.uid; // Only current owner
      
      // Only owner can delete
      allow delete: if request.auth != null 
                    && request.auth.token.email_verified == true
                    && resource.data.ownerId == request.auth.uid;
    }

    // System statistics ‚Äî authenticated users can read, owners can write
    match /system_stats/{systemId} {
      allow read: if request.auth != null 
                  && request.auth.token.email_verified == true;
      
      allow write: if request.auth != null 
                   && request.auth.token.email_verified == true
                   && exists(/databases/$(database)/documents/systems/$(systemId))
                   && get(/databases/$(database)/documents/systems/$(systemId)).data.ownerId == request.auth.uid;
    }

    // ============================================================
    // üìä LOGGING & MONITORING
    // ============================================================

    // Activity logs ‚Äî users can create and read, owners can delete
    match /activity_logs/{logId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null;
      
      allow update: if false; // Logs are immutable
      
      // Owner of the system can delete logs
      allow delete: if request.auth != null 
                    && request.auth.token.email_verified == true;
    }

    // System status logs ‚Äî automatic offline detection logs
    match /system_status_logs/{logId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null;
      
      allow update, delete: if false; // Status logs are immutable
    }

    // Batch completion logs ‚Äî from MEGA hardware
    match /batch_logs/{batchId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null;
      
      allow update, delete: if false; // Batch logs are immutable
    }

    // ============================================================
    // üö´ DENY ALL OTHER ACCESS
    // ============================================================
    
    // Default deny for any unmatched paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
